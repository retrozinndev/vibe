name: "Build and Upload"

on:
  push:
    branches: [ "main" ]
    paths: [ "src/", "lib/" ]
  pull_request:
    branches: [ "main" ]
    paths: [ "src/", "lib/" ]
  workflow_dispatch:


jobs:
  setup_and_build:
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v5.0.0"
        with:
          submodules: "recursive"

      - name: "Setup node and pnpm"
        uses: "pnpm/action-setup@v4.1.0"
        with:
          version: "latest"
          run_install: false
      
      - name: "Install dependencies"
        run: |
          pnpm install
          sudo pnpm add -g esbuild
          sudo apt update -y && apt upgrade -y
          sudo apt install -y libglib2.0-dev build-essential gjs

      - name: "Build project"
        run: "pnpm build:release"

      - name: "Upload for next job"
        uses: "actions/upload-artifact@v4.6.2"
        with:
          name: "build-assets"
          path: |
            package.json
            build/

  upload:
    runs-on: ubuntu-latest
    needs: setup_and_build

    steps:
      - name: "Load from previous job"
        uses: "actions/download-artifact@v4.6.2"
        with:
          name: "build-assets"

      - name: "Install jq"
        run: "sudo apt install -y jq"

      - name: "Setup environment"
        run: "export VIBE_VERSION=\"$(cat package.json | jq -r .version)\""

      - name: "Upload artifact"
        uses: "actions/upload-artifact@v4.6.2"
        with:
          name: "vibe-$VIBE_VERSION"
          path: "build/release"
